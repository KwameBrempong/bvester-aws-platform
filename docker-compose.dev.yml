# ðŸ› ï¸ BVESTER PLATFORM - DEVELOPMENT DOCKER COMPOSE
# Development environment with hot reload and debugging capabilities

version: '3.8'

services:
  # ============================================================================
  # BACKEND API SERVICE (Development)
  # ============================================================================
  backend-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
      target: development
    container_name: bvester-backend-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
      - "9229:9229"  # Node.js debugger port
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DEBUG=bvester:*
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-bvester-dev}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - USE_FIREBASE_EMULATOR=true
      - FIREBASE_EMULATOR_HOST=firebase-emulator:9099
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8080
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-sk_test_}
      - FLUTTERWAVE_SECRET_KEY=${FLUTTERWAVE_SECRET_KEY:-FLWSECK_TEST}
    networks:
      - bvester-dev-network
    volumes:
      - ./backend:/app
      - /app/node_modules
      - backend-dev-logs:/app/logs
    command: ["npm", "run", "dev"]
    depends_on:
      - redis-dev
      - firebase-emulator
    labels:
      - "com.bvester.service=backend-api"
      - "com.bvester.environment=development"

  # ============================================================================
  # WEB APPLICATION SERVICE (Development)
  # ============================================================================
  web-dev:
    build:
      context: .
      dockerfile: Dockerfile.web.dev
      target: development
    container_name: bvester-web-dev
    restart: unless-stopped
    ports:
      - "19006:19006"  # Expo web dev server
      - "19000:19000"  # Expo dev tools
    environment:
      - NODE_ENV=development
      - EXPO_DEVTOOLS_LISTEN_ADDRESS=0.0.0.0
      - REACT_NATIVE_PACKAGER_HOSTNAME=0.0.0.0
      - EXPO_PUBLIC_API_URL=http://localhost:3000
      - EXPO_PUBLIC_USE_FIREBASE_EMULATOR=true
      - EXPO_PUBLIC_ENVIRONMENT=development
    networks:
      - bvester-dev-network
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.expo
    command: ["npm", "run", "web"]
    depends_on:
      - backend-dev
    labels:
      - "com.bvester.service=web-app"
      - "com.bvester.environment=development"

  # ============================================================================
  # FIREBASE EMULATOR SUITE
  # ============================================================================
  firebase-emulator:
    image: node:18-alpine
    container_name: bvester-firebase-emulator
    restart: unless-stopped
    ports:
      - "4000:4000"   # Emulator UI
      - "5000:5000"   # Hosting
      - "5001:5001"   # Functions
      - "8080:8080"   # Firestore
      - "9099:9099"   # Auth
      - "9199:9199"   # Storage
    environment:
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-bvester-dev}
    networks:
      - bvester-dev-network
    volumes:
      - .:/app
      - firebase-emulator-data:/app/.firebase
    working_dir: /app
    command: >
      sh -c "
        npm install -g firebase-tools &&
        firebase emulators:start --host 0.0.0.0 --import=/app/.firebase/emulator-data --export-on-exit=/app/.firebase/emulator-data
      "
    labels:
      - "com.bvester.service=firebase-emulator"
      - "com.bvester.environment=development"

  # ============================================================================
  # REDIS CACHE SERVICE (Development)
  # ============================================================================
  redis-dev:
    image: redis:7-alpine
    container_name: bvester-redis-dev
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    networks:
      - bvester-dev-network
    volumes:
      - redis-dev-data:/data
    labels:
      - "com.bvester.service=redis-cache"
      - "com.bvester.environment=development"

  # ============================================================================
  # DATABASE ADMIN INTERFACE (Optional)
  # ============================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: bvester-redis-ui
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis-dev:6379
    networks:
      - bvester-dev-network
    depends_on:
      - redis-dev
    profiles:
      - admin
    labels:
      - "com.bvester.service=redis-admin"
      - "com.bvester.environment=development"

  # ============================================================================
  # LOG AGGREGATION (Development)
  # ============================================================================
  logger:
    image: datalust/seq:latest
    container_name: bvester-logger
    restart: unless-stopped
    ports:
      - "8082:80"
      - "5341:5341"
    environment:
      - ACCEPT_EULA=Y
    networks:
      - bvester-dev-network
    volumes:
      - logger-data:/data
    profiles:
      - logging
    labels:
      - "com.bvester.service=logger"
      - "com.bvester.environment=development"

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  bvester-dev-network:
    driver: bridge
    labels:
      - "com.bvester.network=development"

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  backend-dev-logs:
    driver: local
    labels:
      - "com.bvester.volume=backend-dev-logs"
  
  redis-dev-data:
    driver: local
    labels:
      - "com.bvester.volume=redis-dev-data"
  
  firebase-emulator-data:
    driver: local
    labels:
      - "com.bvester.volume=firebase-emulator-data"
  
  logger-data:
    driver: local
    labels:
      - "com.bvester.volume=logger-data"