<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline'; font-src 'self' data:; img-src 'self' data: https:; connect-src 'self' https://bvester-backend.vercel.app https://bizinvest-hub-prod.firebaseapp.com https://identitytoolkit.googleapis.com https://firestore.googleapis.com; frame-src 'none'; object-src 'none'; base-uri 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    
    <title>KYC Verification - Bvester</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Navigation */
        .nav-container {
            background: #000000;
            padding: 16px 24px;
            border-bottom: 1px solid #ffd700;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #ffd700;
        }

        .nav-links {
            display: flex;
            gap: 24px;
        }

        .nav-link {
            color: #ffffff;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: #ffd700;
        }

        /* Main Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Progress Indicator */
        .progress-container {
            margin-bottom: 40px;
        }

        .progress-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .progress-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .progress-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #ffd700, #ffed4a);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #ffd700;
            color: #000000;
            border-color: #ffd700;
        }

        .step.completed .step-number {
            background: #4ade80;
            color: #000000;
            border-color: #4ade80;
        }

        .step-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .step.active .step-label {
            color: #ffd700;
        }

        .step.completed .step-label {
            color: #4ade80;
        }

        /* KYC Form Sections */
        .kyc-section {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
        }

        .kyc-section.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .section-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Document Upload */
        .upload-area {
            border: 2px dashed rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.02);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: #ffd700;
            margin-bottom: 16px;
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .upload-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            margin-top: 16px;
        }

        .file-icon {
            color: #4ade80;
            font-size: 1.5rem;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            color: #ffffff;
            font-weight: 500;
        }

        .file-size {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        .remove-file {
            color: #ef4444;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .remove-file:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Document Requirements */
        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .requirement-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .requirement-icon {
            font-size: 2.5rem;
            margin-bottom: 16px;
            display: block;
        }

        .requirement-title {
            color: #ffd700;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .requirement-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 16px;
            justify-content: space-between;
            margin-top: 40px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #000000;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Status Messages */
        .status-message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }

        /* Loading State */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-top: 2px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .progress-steps {
                flex-wrap: wrap;
                gap: 10px;
            }

            .step {
                min-width: 80px;
            }

            .step-label {
                font-size: 0.7rem;
            }

            .requirements-grid {
                grid-template-columns: 1fr;
            }

            .kyc-section {
                padding: 24px 20px;
            }
        }

        /* Camera/Selfie Styles */
        .camera-container {
            position: relative;
            margin: 20px 0;
        }

        .camera-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .camera-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
        }

        .camera-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }

        .camera-btn {
            padding: 12px 24px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            border-radius: 6px;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .camera-btn:hover {
            background: rgba(255, 215, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-content">
            <div class="logo">Bvester</div>
            <div class="nav-links">
                <a href="investor-dashboard.html" class="nav-link">Dashboard</a>
                <a href="login.html" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Progress Section -->
        <div class="progress-container">
            <div class="progress-header">
                <h1 class="progress-title">KYC Verification</h1>
                <p class="progress-subtitle">Complete your identity verification to start investing</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="progress-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Personal Info</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Documents</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Verification</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Step 1: Personal Information -->
        <div class="kyc-section active" id="step1">
            <h2 class="section-title">Personal Information</h2>
            <p class="section-description">
                Please provide your personal details exactly as they appear on your government-issued ID.
            </p>

            <form id="personalInfoForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="firstName">First Name *</label>
                        <input type="text" id="firstName" name="firstName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="lastName">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="middleName">Middle Name</label>
                        <input type="text" id="middleName" name="middleName" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="dateOfBirth">Date of Birth *</label>
                        <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="nationality">Nationality *</label>
                        <select id="nationality" name="nationality" class="form-select" required>
                            <option value="">Select Country</option>
                            <option value="NG">Nigeria</option>
                            <option value="GH">Ghana</option>
                            <option value="KE">Kenya</option>
                            <option value="ZA">South Africa</option>
                            <option value="UG">Uganda</option>
                            <option value="TZ">Tanzania</option>
                            <option value="EG">Egypt</option>
                            <option value="MA">Morocco</option>
                            <option value="US">United States</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="phoneNumber">Phone Number *</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="form-input" placeholder="+234 xxx xxx xxxx" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="address">Full Address *</label>
                    <textarea id="address" name="address" class="form-input" rows="3" placeholder="Enter your complete address" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="city">City *</label>
                        <input type="text" id="city" name="city" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="postalCode">Postal Code</label>
                        <input type="text" id="postalCode" name="postalCode" class="form-input">
                    </div>
                </div>
            </form>
        </div>

        <!-- Step 2: Document Upload -->
        <div class="kyc-section" id="step2">
            <h2 class="section-title">Document Verification</h2>
            <p class="section-description">
                Upload clear, high-quality images of your documents. All documents must be current and valid.
            </p>

            <div class="requirements-grid">
                <div class="requirement-card">
                    <div class="requirement-icon">üÜî</div>
                    <div class="requirement-title">Government ID</div>
                    <div class="requirement-description">
                        Passport, National ID, or Driver's License. Must be government-issued and current.
                    </div>
                </div>
                <div class="requirement-card">
                    <div class="requirement-icon">üè†</div>
                    <div class="requirement-title">Proof of Address</div>
                    <div class="requirement-description">
                        Utility bill, bank statement, or official document dated within the last 3 months.
                    </div>
                </div>
                <div class="requirement-card">
                    <div class="requirement-icon">ü§≥</div>
                    <div class="requirement-title">Selfie Verification</div>
                    <div class="requirement-description">
                        Clear selfie holding your ID document for identity verification.
                    </div>
                </div>
            </div>

            <!-- Identity Document Upload -->
            <div class="form-group">
                <label class="form-label">Government-Issued ID *</label>
                <div class="upload-area" onclick="triggerFileUpload('idDocument')">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">PNG, JPG, PDF up to 10MB</div>
                </div>
                <input type="file" id="idDocument" class="file-input" accept=".jpg,.jpeg,.png,.pdf" onchange="handleFileUpload(this, 'idDocumentPreview')">
                <div id="idDocumentPreview"></div>
            </div>

            <!-- Address Proof Upload -->
            <div class="form-group">
                <label class="form-label">Proof of Address *</label>
                <div class="upload-area" onclick="triggerFileUpload('addressProof')">
                    <div class="upload-icon">üè†</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">PNG, JPG, PDF up to 10MB</div>
                </div>
                <input type="file" id="addressProof" class="file-input" accept=".jpg,.jpeg,.png,.pdf" onchange="handleFileUpload(this, 'addressProofPreview')">
                <div id="addressProofPreview"></div>
            </div>

            <!-- Selfie Upload -->
            <div class="form-group">
                <label class="form-label">Selfie with ID *</label>
                <div class="camera-container">
                    <div class="camera-preview" id="cameraPreview">
                        <div class="camera-placeholder">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üì∏</div>
                            <div>Take a selfie holding your ID</div>
                        </div>
                    </div>
                    <div class="camera-controls">
                        <button type="button" class="camera-btn" onclick="startCamera()">üìπ Start Camera</button>
                        <button type="button" class="camera-btn" onclick="capturePhoto()">üì∏ Take Photo</button>
                        <button type="button" class="camera-btn" onclick="triggerFileUpload('selfieUpload')">üìÅ Upload File</button>
                    </div>
                </div>
                <input type="file" id="selfieUpload" class="file-input" accept=".jpg,.jpeg,.png" onchange="handleFileUpload(this, 'selfiePreview')">
                <div id="selfiePreview"></div>
            </div>
        </div>

        <!-- Step 3: Verification Review -->
        <div class="kyc-section" id="step3">
            <h2 class="section-title">Review & Submit</h2>
            <p class="section-description">
                Please review your information before submitting for verification.
            </p>

            <div id="reviewContent">
                <!-- Review content will be populated by JavaScript -->
            </div>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="termsAgreement" style="margin-right: 8px;">
                    I agree to the <a href="#" style="color: #ffd700;">Terms of Service</a> and <a href="#" style="color: #ffd700;">Privacy Policy</a>
                </label>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="dataConsent" style="margin-right: 8px;">
                    I consent to the processing of my personal data for KYC verification purposes
                </label>
            </div>
        </div>

        <!-- Step 4: Completion -->
        <div class="kyc-section" id="step4">
            <div style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 24px;">‚úÖ</div>
                <h2 class="section-title">Verification Submitted!</h2>
                <p class="section-description">
                    Your KYC verification has been submitted successfully. Our team will review your documents within 24-48 hours.
                    You'll receive an email notification once the verification is complete.
                </p>
                
                <div style="margin: 40px 0;">
                    <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 24px;">
                        <h3 style="color: #ffd700; margin-bottom: 16px;">What happens next?</h3>
                        <ul style="text-align: left; color: rgba(255, 255, 255, 0.8); line-height: 1.8;">
                            <li>üìã Our compliance team reviews your documents</li>
                            <li>‚úÖ Verification typically completes within 24-48 hours</li>
                            <li>üìß You'll receive an email notification with the result</li>
                            <li>üöÄ Once verified, you can start investing immediately</li>
                        </ul>
                    </div>
                </div>

                <a href="investor-dashboard.html" class="btn btn-primary" style="text-decoration: none;">
                    Return to Dashboard
                </a>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="button-group">
            <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                ‚Üê Previous
            </button>
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Next ‚Üí
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdTIb1Hpue64ZqzkcsjlTWP747TW_CJ80",
            authDomain: "bizinvest-hub-prod.firebaseapp.com",
            projectId: "bizinvest-hub-prod",
            storageBucket: "bizinvest-hub-prod.firebasestorage.app",
            messagingSenderId: "19849690024",
            appId: "1:19849690024:web:134ceb9fc20fec428a3b9d",
            measurementId: "G-3M77VNP2YC"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Security Helper Functions
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;');
        }

        // KYC Application State
        let currentStep = 1;
        let kycData = {
            personalInfo: {},
            documents: {},
            status: 'draft'
        };

        let camera = null;
        let canvas = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStepProgress();
            updateButtons();
            
            // Check authentication
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'login.html';
                }
            });
        });

        // Step Navigation
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < 4) {
                    currentStep++;
                    showStep(currentStep);
                    updateStepProgress();
                    updateButtons();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateStepProgress();
                updateButtons();
            }
        }

        function showStep(step) {
            // Hide all sections
            document.querySelectorAll('.kyc-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show current section
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
        }

        function updateStepProgress() {
            const progress = ((currentStep - 1) / 3) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.style.display = currentStep > 1 ? 'flex' : 'none';
            
            if (currentStep === 3) {
                nextBtn.textContent = 'Submit for Verification';
                nextBtn.onclick = submitKYC;
            } else if (currentStep === 4) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = nextStep;
            }
        }

        // Validation
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return validatePersonalInfo();
                case 2:
                    return validateDocuments();
                case 3:
                    return validateReview();
                default:
                    return true;
            }
        }

        function validatePersonalInfo() {
            const form = document.getElementById('personalInfoForm');
            const formData = new FormData(form);
            
            const required = ['firstName', 'lastName', 'dateOfBirth', 'nationality', 'phoneNumber', 'address', 'city'];
            
            for (const field of required) {
                if (!formData.get(field)) {
                    showMessage(`Please fill in your ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
                    return false;
                }
            }
            
            // Save personal info
            kycData.personalInfo = Object.fromEntries(formData);
            
            return true;
        }

        function validateDocuments() {
            const requiredDocs = ['idDocument', 'addressProof'];
            
            for (const doc of requiredDocs) {
                if (!kycData.documents[doc]) {
                    showMessage(`Please upload your ${doc.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
                    return false;
                }
            }
            
            if (!kycData.documents.selfie) {
                showMessage('Please take a selfie or upload a selfie with your ID', 'error');
                return false;
            }
            
            return true;
        }

        function validateReview() {
            const termsAgreement = document.getElementById('termsAgreement').checked;
            const dataConsent = document.getElementById('dataConsent').checked;
            
            if (!termsAgreement) {
                showMessage('Please agree to the Terms of Service and Privacy Policy', 'error');
                return false;
            }
            
            if (!dataConsent) {
                showMessage('Please consent to data processing for KYC verification', 'error');
                return false;
            }
            
            // Populate review content
            populateReviewContent();
            
            return true;
        }

        // File Upload Handling
        function triggerFileUpload(inputId) {
            document.getElementById(inputId).click();
        }

        function handleFileUpload(input, previewId) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file
            if (file.size > 10 * 1024 * 1024) {
                showMessage('File size must be less than 10MB', 'error');
                return;
            }
            
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('Please upload a JPEG, PNG, or PDF file', 'error');
                return;
            }
            
            // Store file reference
            const docType = input.id;
            kycData.documents[docType] = file;
            
            // Show preview
            showFilePreview(file, previewId);
        }

        function showFilePreview(file, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = `
                <div class="uploaded-file">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-info">
                        <div class="file-name">${sanitizeInput(file.name)}</div>
                        <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <div class="remove-file" onclick="removeFile('${previewId}', '${file.name}')">üóëÔ∏è</div>
                </div>
            `;
        }

        function removeFile(previewId, fileName) {
            document.getElementById(previewId).innerHTML = '';
            // Remove from kycData
            for (const key in kycData.documents) {
                if (kycData.documents[key] && kycData.documents[key].name === fileName) {
                    delete kycData.documents[key];
                    break;
                }
            }
        }

        // Camera Functions
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 400, 
                        height: 300,
                        facingMode: 'user'
                    } 
                });
                
                const preview = document.getElementById('cameraPreview');
                preview.innerHTML = '<video id="cameraVideo" autoplay style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"></video>';
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                camera = stream;
                
            } catch (error) {
                console.error('Camera error:', error);
                showMessage('Unable to access camera. Please upload a file instead.', 'error');
            }
        }

        function capturePhoto() {
            if (!camera) {
                showMessage('Please start the camera first', 'error');
                return;
            }
            
            const video = document.getElementById('cameraVideo');
            canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Convert to blob
            canvas.toBlob((blob) => {
                const file = new File([blob], 'selfie.jpg', { type: 'image/jpeg' });
                kycData.documents.selfie = file;
                
                // Show preview
                const preview = document.getElementById('cameraPreview');
                preview.innerHTML = `<img src="${canvas.toDataURL()}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">`;
                
                // Stop camera
                camera.getTracks().forEach(track => track.stop());
                camera = null;
                
                showMessage('Selfie captured successfully!', 'success');
            }, 'image/jpeg', 0.8);
        }

        // KYC Submission
        async function submitKYC() {
            try {
                const nextBtn = document.getElementById('nextBtn');
                nextBtn.innerHTML = '<div class="loading"><div class="spinner"></div>Submitting...</div>';
                nextBtn.disabled = true;
                
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                // Upload documents to Firebase Storage
                const documentUrls = {};
                
                for (const [docType, file] of Object.entries(kycData.documents)) {
                    if (file) {
                        const timestamp = Date.now();
                        const fileName = `kyc/${user.uid}/${docType}_${timestamp}`;
                        const uploadTask = await storage.ref(fileName).put(file);
                        documentUrls[docType] = await uploadTask.ref.getDownloadURL();
                    }
                }
                
                // Create KYC record
                const kycRecord = {
                    userId: user.uid,
                    personalInfo: kycData.personalInfo,
                    documents: documentUrls,
                    status: 'pending',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Save to Firestore
                await db.collection('kycVerifications').doc(user.uid).set(kycRecord);
                
                // Update user profile
                await db.collection('users').doc(user.uid).update({
                    'kyc.status': 'pending',
                    'kyc.submittedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Proceed to completion step
                currentStep = 4;
                showStep(currentStep);
                updateStepProgress();
                updateButtons();
                
                showMessage('KYC verification submitted successfully!', 'success');
                
            } catch (error) {
                console.error('KYC submission error:', error);
                showMessage('Failed to submit KYC verification. Please try again.', 'error');
                
                const nextBtn = document.getElementById('nextBtn');
                nextBtn.innerHTML = 'Submit for Verification';
                nextBtn.disabled = false;
            }
        }

        // Utility Functions
        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = sanitizeInput(message);
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        function populateReviewContent() {
            const reviewContent = document.getElementById('reviewContent');
            
            reviewContent.innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                    <h3 style="color: #ffd700; margin-bottom: 16px;">Personal Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div><strong>Name:</strong> ${sanitizeInput(kycData.personalInfo.firstName)} ${sanitizeInput(kycData.personalInfo.lastName)}</div>
                        <div><strong>Date of Birth:</strong> ${sanitizeInput(kycData.personalInfo.dateOfBirth)}</div>
                        <div><strong>Nationality:</strong> ${sanitizeInput(kycData.personalInfo.nationality)}</div>
                        <div><strong>Phone:</strong> ${sanitizeInput(kycData.personalInfo.phoneNumber)}</div>
                    </div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 24px;">
                    <h3 style="color: #ffd700; margin-bottom: 16px;">Documents Uploaded</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        ${Object.keys(kycData.documents).map(doc => `
                            <div style="text-align: center; padding: 16px; background: rgba(0, 255, 0, 0.1); border-radius: 8px;">
                                <div style="font-size: 2rem; margin-bottom: 8px;">‚úÖ</div>
                                <div>${doc.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Drag and Drop Support
        document.querySelectorAll('.upload-area').forEach(area => {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const input = area.nextElementSibling;
                    input.files = files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        });
    </script>
</body>
</html>